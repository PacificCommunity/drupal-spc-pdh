<?php
/**
 * @file
 * Code for the Home Page feature.
 */

include_once 'home_page.features.inc';

/**
 * Implementation of hook_preprocess_HOOK().
 */
function home_page_preprocess_entity(&$variables) {
	if ($variables['entity_type'] == 'bean') {
		$bean = $variables['bean'];
		if (in_array($bean->type, array('members_countries'))) {
			$variables['show'] = 0;
			$wrapper = entity_metadata_wrapper('bean', $bean);
			if (isset($wrapper->field_show)) {
				$variables['show'] = $wrapper->field_show->raw();
			}
			if (!empty($variables['content']['field_members_countries'])) {
				// Getting geodata.
				$points = array();
				if ($wrapper->field_mcountries_geojson) {
					$geojsondata = $wrapper->field_mcountries_geojson->value();
					$geojson = drupal_json_decode($geojsondata);
					if (isset($geojson['features']) && !empty($geojson['features'])) {
						foreach ($geojson['features'] as $feature) {
							if (!empty($feature['properties'])) {
								$properties = $feature['properties'];
								$name = drupal_strtolower($properties['GeoName']);
								$points[$name] = array(
									'lat' => $properties['x_1'],
									'lng' => $properties['y_1']
								);
							}							
						}
					}
				}
				kpr($points);
				foreach (element_children($variables['content']['field_members_countries']) as $index) {
					$element = $variables['content']['field_members_countries'][$index]['#element'];
					$data_title = $element['title'];
					$data_request = '';
					$data_code = '';
					$link_url = $element['url'];
					$params = drupal_parse_url($link_url);
					$query = $params['query'];
					if (!empty($query) && !empty($query['member_countries'])) {
						$country_code = $query['member_countries'];
						$data_code = $country_code;
						$request_path = 'data/api/action/package_search';
						$request_options = array('absolute' => TRUE, 'query' => array('fq' => 'member_countries:' . $country_code));
						$data_request = url($request_path, $request_options);
					}
					$variables['content']['field_members_countries'][$index]['#element']['attributes']['data-request'] = $data_request; 
					$variables['content']['field_members_countries'][$index]['#element']['attributes']['data-title'] = $data_title;
					$variables['content']['field_members_countries'][$index]['#element']['attributes']['data-code'] = $data_code;
				}
			}
		}
	}
}


/**
 * Implements hook_theme().
 */

function home_page_theme($existing, $type, $theme, $path) {
  if($type == 'module'){
    return [
      'homepage_stats' => [
		'variables' => array(),
		'template' => 'homepage_stats'
      ]
    ];
  }
  return [];
}


/**
 * Implements hook_block_info().
 */

function home_page_block_info() {
  $blocks['home_page_stats_show'] = [
    'info' => t('Homepage stats show')
  ];
  return $blocks;
}


/**
 * Implements hook_block_view().
 */

function home_page_block_view($delta='') {
	$block = array();

	switch($delta) {
		case 'home_page_stats_show' :
			$snippet= theme('homepage_stats');
			$block['content'] = "<div>". $snippet ."</div>";
			break;
	}

	return $block;
}